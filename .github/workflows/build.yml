name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Resolve Package Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Ambi.xcodeproj \
            -scheme Ambi
      
      - name: Build App
        run: |
          xcodebuild -project Ambi.xcodeproj \
            -scheme Ambi \
            -configuration Release \
            -derivedDataPath ./build \
            -destination 'platform=macOS,arch=arm64' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Generate DMG Background
        run: |
          swift scripts/generate-dmg-background.swift dmg-background.png
      
      - name: Create Styled DMG
        run: |
          APP_PATH="./build/Build/Products/Release/Ambi.app"
          DMG_NAME="Ambi-$(date +%Y%m%d)"
          
          # Create temporary DMG directory
          mkdir -p dmg_temp
          cp -R "$APP_PATH" dmg_temp/
          ln -s /Applications dmg_temp/Applications
          
          # Create initial DMG
          hdiutil create -volname "Ambi" \
            -srcfolder dmg_temp \
            -ov -format UDRW \
            temp.dmg
          
          # Mount DMG
          MOUNT_DIR=$(hdiutil attach temp.dmg | grep "/Volumes/Ambi" | awk '{print $3}')
          
          # Create .background directory and copy background
          mkdir -p "$MOUNT_DIR/.background"
          cp dmg-background.png "$MOUNT_DIR/.background/background.png"
          
          # Set DMG styling using AppleScript
          osascript <<EOF
          tell application "Finder"
            tell disk "Ambi"
              open
              set current view of container window to icon view
              set toolbar visible of container window to false
              set statusbar visible of container window to false
              set the bounds of container window to {100, 100, 760, 500}
              set viewOptions to the icon view options of container window
              set arrangement of viewOptions to not arranged
              set icon size of viewOptions to 100
              set background picture of viewOptions to file ".background:background.png"
              set position of item "Ambi.app" of container window to {165, 180}
              set position of item "Applications" of container window to {495, 180}
              close
              open
              update without registering applications
              delay 2
            end tell
          end tell
          EOF
          
          # Finalize
          sync
          hdiutil detach "$MOUNT_DIR"
          
          # Convert to compressed DMG
          hdiutil convert temp.dmg -format UDZO -o "$DMG_NAME.dmg"
          cp "$DMG_NAME.dmg" Ambi-latest.dmg
          
          # Cleanup
          rm -f temp.dmg
          rm -rf dmg_temp
      
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Ambi-DMG
          path: Ambi-*.dmg
          retention-days: 30
      
      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: Ambi-*.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
