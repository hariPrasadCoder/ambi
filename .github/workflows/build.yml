name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Resolve Package Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Ambi.xcodeproj \
            -scheme Ambi
      
      - name: Build App
        run: |
          xcodebuild -project Ambi.xcodeproj \
            -scheme Ambi \
            -configuration Release \
            -derivedDataPath ./build \
            -destination 'platform=macOS,arch=arm64' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Create DMG
        run: |
          # Find the built app
          APP_PATH="./build/Build/Products/Release/Ambi.app"
          
          # Create DMG folder structure
          mkdir -p dmg_contents
          cp -R "$APP_PATH" dmg_contents/
          
          # Create Applications symlink
          ln -s /Applications dmg_contents/Applications
          
          # Create DMG
          hdiutil create -volname "Ambi" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            Ambi-$(date +%Y%m%d).dmg
          
          # Also create a consistently named one
          cp Ambi-$(date +%Y%m%d).dmg Ambi-latest.dmg
      
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Ambi-DMG
          path: Ambi-*.dmg
          retention-days: 30
      
      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: Ambi-*.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
